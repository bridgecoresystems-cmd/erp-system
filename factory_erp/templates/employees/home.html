{% extends 'base.html' %}

{% block title %}HR –°–∏—Å—Ç–µ–º–∞ - –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div style="text-align: center; padding: 60px 20px;">
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <h1 style="color: #667eea; margin-bottom: 20px; font-size: 2.5em;">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HR –°–∏—Å—Ç–µ–º—É! üëã
        </h1>
        
        <p style="font-size: 1.2em; color: #666; margin-bottom: 40px;">
            –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
                <div style="font-size: 2em; margin-bottom: 10px;">üë•</div>
                <h3 style="margin: 0 0 5px 0;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
                <p style="margin: 0; opacity: 0.9;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º</p>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; text-align: center;">
                <div style="font-size: 2em; margin-bottom: 10px;">üé´</div>
                <h3 style="margin: 0 0 5px 0;">–î–æ—Å—Ç—É–ø</h3>
                <p style="margin: 0; opacity: 0.9;">–ö–æ–Ω—Ç—Ä–æ–ª—å –≤—Ö–æ–¥–∞</p>
            </div>
            
            <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; text-align: center;">
                <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                <h3 style="margin: 0 0 5px 0;">–û—Ç—á–µ—Ç—ã</h3>
                <p style="margin: 0; opacity: 0.9;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
        </div>
        
        {% if user.is_authenticated %}
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                {% for group in user.groups.all %}
                    {% if group.name == "HR_Admins" %}
                        <a href="{% url 'employees:employee_list' %}" class="btn">
                            üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏
                        </a>
                        <a href="{% url 'employees:employee_add' %}" class="btn btn-secondary">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        </a>
                    {% elif group.name == "HR_Users" %}
                        <a href="{% url 'employees:worktime_list' %}" class="btn">
                            ‚è∞ –†–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è
                        </a>
                    {% elif group.name == "Security" %}
                        <a href="{% url 'security:dashboard' %}" class="btn">
                            üõ°Ô∏è –ü–∞–Ω–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                        </a>
                    {% elif group.name == "Security_Users" %}
                        <a href="{% url 'employees:security_display' %}" class="btn">
                            üñ•Ô∏è –≠–∫—Ä–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                        </a>
                    {% endif %}
                {% empty %}
                    <a href="{% url 'employees:employee_list' %}" class="btn">
                        üë• –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div>
                <p style="color: #666;">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
                <a href="{% url 'admin:login' %}" class="btn">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
            </div>
        {% endif %}
    </div>
    
    {% if user.is_authenticated %}
        <div style="margin-top: 40px;">
            <div class="card">
                <h3 style="text-align: center; margin-bottom: 20px;">
                    –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    <div id="websocket-status" style="display: none; margin-left: 10px; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                        üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
                    </div>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center;">
                    <div>
                        <div id="total-employees" style="font-size: 2em; color: #667eea;">‚Äî</div>
                        <div style="font-weight: bold;">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div>
                        <div id="active-employees" style="font-size: 2em; color: #4caf50;">‚Äî</div>
                        <div style="font-weight: bold;">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                    <div>
                        <div id="today-at-work" style="font-size: 2em; color: #ff9800;">‚Äî</div>
                        <div style="font-weight: bold;">–°–µ–≥–æ–¥–Ω—è –Ω–∞ —Ä–∞–±–æ—Ç–µ</div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ WebSocket
                </p>
            </div>
        </div>
    {% endif %}
</div>

<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let employeeSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/employees/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Employee WebSocket:', wsUrl);
    updateWebSocketStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    
    employeeSocket = new WebSocket(wsUrl);
    
    employeeSocket.onopen = function(event) {
        console.log('‚úÖ Employee WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        updateWebSocketStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
        reconnectAttempts = 0;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        requestEmployeeStats();
    };
    
    employeeSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if (data.type === 'employee_data' || data.type === 'employee_update') {
                updateEmployeeStats(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    employeeSocket.onclose = function(event) {
        console.log('‚ùå Employee WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        employeeSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            // Fallback –Ω–∞ AJAX
            startAjaxFallback();
        }
    };
    
    employeeSocket.onerror = function(error) {
        console.error('‚ùå Employee WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function requestEmployeeStats() {
    if (employeeSocket && employeeSocket.readyState === WebSocket.OPEN) {
        employeeSocket.send(JSON.stringify({type: 'get_employee_data'}));
    }
}

function updateEmployeeStats(employeeData) {
    if (!employeeData || !Array.isArray(employeeData)) return;
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const totalEmployees = employeeData.length;
    const activeEmployees = employeeData.filter(emp => emp.is_active).length;
    const todayAtWork = employeeData.filter(emp => {
        if (!emp.last_seen) return false;
        const lastSeen = new Date(emp.last_seen);
        const today = new Date();
        return lastSeen.toDateString() === today.toDateString();
    }).length;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    const totalEl = document.getElementById('total-employees');
    const activeEl = document.getElementById('active-employees');
    const todayEl = document.getElementById('today-at-work');
    
    if (totalEl) totalEl.textContent = totalEmployees;
    if (activeEl) activeEl.textContent = activeEmployees;
    if (todayEl) todayEl.textContent = todayAtWork;
    
    console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: –í—Å–µ–≥–æ: ${totalEmployees}, –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeEmployees}, –°–µ–≥–æ–¥–Ω—è: ${todayAtWork}`);
}

// Fallback –Ω–∞ AJAX –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX fallback –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
    updateInterval = setInterval(loadEmployeeStats, 5000);
}

function loadEmployeeStats() {
    fetch('/employees/api/stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateEmployeeStats(data.employees);
            }
        })
        .catch(error => {
            console.error('Error loading employee stats:', error);
        });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HR —Å–∏—Å—Ç–µ–º—ã —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (employeeSocket) {
        employeeSocket.close();
    }
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}