<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            color: white;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-display {
            flex: 1;
            display: flex;
            justify-content: space-between;
            gap: 30px;
        }

        .employee-card {
            flex: 2;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 400px;
        }

        .waiting-message {
            font-size: 2.5em;
            opacity: 0.7;
            animation: pulse 2s infinite;
        }

        .employee-info {
            display: none;
        }

        .employee-photo {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid rgba(255,255,255,0.3);
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .employee-name {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .employee-details {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .employee-details div {
            margin: 8px 0;
        }

        .stats-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            opacity: 0.7;
        }

        .welcome-animation {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .time-display {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5em;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="time-display" id="currentTime"></div>
        <div class="status-indicator" id="statusIndicator"></div>
        
        <div class="header">
            <h1>üè≠ –°–ò–°–¢–ï–ú–ê –ö–û–ù–¢–†–û–õ–Ø –î–û–°–¢–£–ü–ê</h1>
            <div class="subtitle">–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –∫ —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—é</div>
        </div>
        
        <div class="main-display">
            <div class="employee-card" id="employeeCard">
                <div class="waiting-message" id="waitingMessage">
                    üë§ –û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...
                </div>
                
                <div class="employee-info" id="employeeInfo">
                    <img src="" alt="–§–æ—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" class="employee-photo" id="employeePhoto">
                    <div class="employee-name" id="employeeName"></div>
                    <div class="employee-details">
                        <div><strong>–¶–µ—Ö:</strong> <span id="employeeDepartment"></span></div>
                        <div><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> <span id="employeePosition"></span></div>
                        <div><strong>–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ:</strong> <span id="employeeId"></span></div>
                    </div>
                </div>
            </div>
            
            <div class="stats-panel">
                <div class="stat-card">
                    <span class="stat-number" id="todayAccesses">0</span>
                    <div class="stat-label">–ü—Ä–æ—Ö–æ–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-number" id="uniqueEmployees">0</span>
                    <div class="stat-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Ä–∞–±–æ—Ç–µ</div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-number" id="totalEmployees">0</span>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>ü§ñ ERP –°–∏—Å—Ç–µ–º–∞ | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="lastUpdate">--:--:--</span></p>
        </div>
    </div>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞—Å–∞–Ω–∏—è
        let lastAccessTime = null;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU');
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function updateStats() {
            try {
                const response = await fetch('/api/dashboard-stats/');
                const data = await response.json();
                
                document.getElementById('todayAccesses').textContent = data.today_accesses;
                document.getElementById('uniqueEmployees').textContent = data.unique_employees_today;
                document.getElementById('totalEmployees').textContent = data.total_active_employees;
                document.getElementById('lastUpdate').textContent = data.last_update;
                
                // –ó–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
                document.getElementById('statusIndicator').style.background = '#4CAF50';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                // –ö—Ä–∞—Å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏
                document.getElementById('statusIndicator').style.background = '#F44336';
            }
        }
        
        // –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
        function showEmployee(employeeData) {
            console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', employeeData);
            
            const waitingMsg = document.getElementById('waitingMessage');
            const employeeInfo = document.getElementById('employeeInfo');
            const employeeCard = document.getElementById('employeeCard');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            document.getElementById('employeePhoto').src = employeeData.photo_url;
            document.getElementById('employeeName').textContent = employeeData.full_name;
            document.getElementById('employeeDepartment').textContent = employeeData.department;
            document.getElementById('employeePosition').textContent = employeeData.position;
            document.getElementById('employeeId').textContent = employeeData.employee_id;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
            waitingMsg.style.display = 'none';
            employeeInfo.style.display = 'block';
            employeeCard.classList.add('welcome-animation');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ–∂–∏–¥–∞–Ω–∏—é —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                employeeInfo.style.display = 'none';
                waitingMsg.style.display = 'block';
                employeeCard.classList.remove('welcome-animation');
            }, 5000);
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∫–∞—Å–∞–Ω–∏–π
        async function checkForNewAccess() {
            try {
                const response = await fetch('/api/latest-access/');
                const data = await response.json();
                
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∫–∞—Å–∞–Ω–∏–π:', data);
                
                if (data.success && data.has_new_access) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–æ–≤–æ–µ –ª–∏ —ç—Ç–æ –∫–∞—Å–∞–Ω–∏–µ
                    const currentAccessTime = data.access_time;
                    
                    if (lastAccessTime !== currentAccessTime) {
                        console.log('–ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ!');
                        lastAccessTime = currentAccessTime;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
                        showEmployee(data.employee);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        updateStats();
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∫–∞—Å–∞–Ω–∏–π:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
            
            updateTime();
            updateStats();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateTime, 1000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(updateStats, 10000);
            
            // –ì–õ–ê–í–ù–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∫–∞—Å–∞–Ω–∏—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É!
            setInterval(checkForNewAccess, 1000);
            
            console.log('–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Å–∞–Ω–∏–π –∫–∞—Ä—Ç...');
        });
        
        // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
        function testEmployee() {
            const testData = {
                full_name: "–¢–µ—Å—Ç–æ–≤—ã–π –°–æ—Ç—Ä—É–¥–Ω–∏–∫",
                department: "IT –û—Ç–¥–µ–ª",
                position: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫",
                employee_id: "TEST001",
                photo_url: "/static/images/no-photo.png"
            };
            showEmployee(testData);
        }
        
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        document.addEventListener('dblclick', testEmployee);
    </script>

    <script>
        // WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (Security)
        let securitySocket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelayMs = 3000;

        function connectSecurityWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/security/`;

            console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Security WebSocket –¥–ª—è –¥–∏—Å–ø–ª–µ—è:', wsUrl);

            securitySocket = new WebSocket(wsUrl);

            securitySocket.onopen = () => {
                console.log('‚úÖ Security WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω (display)');
                reconnectAttempts = 0;
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                requestSecurityData();
            };

            securitySocket.onmessage = (event) => {
                try {
                    const payload = JSON.parse(event.data);
                    if (payload.type === 'access_event') {
                        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                        if (payload.data && payload.data.employee) {
                            showEmployee(payload.data.employee);
                            // –û–±–Ω–æ–≤–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∞
                            if (payload.data.stats) {
                                applyStats(payload.data.stats);
                            }
                        }
                    } else if (payload.type === 'security_data') {
                        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                        applyStats(payload.data);
                    }
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ WS —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                }
            };

            securitySocket.onclose = () => {
                console.warn('‚ùå Security WebSocket –∑–∞–∫—Ä—ã—Ç (display)');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts += 1;
                    setTimeout(connectSecurityWebSocket, reconnectDelayMs);
                }
            };

            securitySocket.onerror = (err) => {
                console.error('‚ùå WS –æ—à–∏–±–∫–∞ (display):', err);
            };
        }

        function requestSecurityData() {
            if (securitySocket && securitySocket.readyState === WebSocket.OPEN) {
                securitySocket.send(JSON.stringify({ type: 'get_security_data' }));
            }
        }

        function applyStats(stats) {
            if (!stats) return;
            if (typeof stats.today_accesses === 'number') {
                const el = document.getElementById('todayAccesses');
                if (el) el.textContent = stats.today_accesses;
            }
            if (typeof stats.unique_employees_today === 'number') {
                const el = document.getElementById('uniqueEmployees');
                if (el) el.textContent = stats.unique_employees_today;
            }
            if (typeof stats.total_active_employees === 'number') {
                const el = document.getElementById('totalEmployees');
                if (el) el.textContent = stats.total_active_employees;
            }
            if (stats.last_update) {
                const el = document.getElementById('lastUpdate');
                if (el) el.textContent = stats.last_update;
            }
            // –ó–µ–ª–µ–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä - —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–≤–µ—á–∞–µ—Ç
            const ind = document.getElementById('statusIndicator');
            if (ind) ind.style.background = '#4CAF50';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WS –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–π–º–µ—Ä–æ–≤ (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ fallback)
        document.addEventListener('DOMContentLoaded', function () {
            connectSecurityWebSocket();
        });
    </script>
</body>
</html>