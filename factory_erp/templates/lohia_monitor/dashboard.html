{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title %}–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞–Ω–∫–æ–≤ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="lohia-card" style="margin-bottom: 15px;">
        <div class="lohia-card-header" style="font-size: 16px; padding: 10px 15px;">
            üè≠ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞–Ω–∫–æ–≤ Lohia
            <div id="websocket-status" style="display: none; float: right; font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">
                üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–Ω–∫–æ–≤ -->
    <div class="lohia-card">
        <div class="lohia-card-body" style="padding: 15px;">
            <div class="lohia-table-wrapper">
                <table class="lohia-table lohia-table-compact">
                    <thead>
                        <tr>
                            <th style="width: 40px;">‚Ññ</th>
                            <th style="width: 150px;">–ò–º—è —Å—Ç–∞–Ω–∫–∞</th>
                            <th style="width: 100px;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="width: 180px;">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                            <th style="width: 120px;">–ú–µ—Ç—Ä–∞–∂ (–º)</th>
                            <th style="width: 100px;">–í—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞</th>
                            <th style="width: 180px;">–ú–∞—Å—Ç–µ—Ä</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in machines_data %}
                        <tr class="machine-row" data-machine-id="{{ item.machine.id }}">
                            <td style="text-align: center; font-size: 12px;">{{ forloop.counter }}</td>
                            <td style="font-size: 12px; font-weight: 500;">
                                <a href="{% url 'lohia_monitor:machine_detail' item.machine.id %}" style="color: #007bff; text-decoration: none;">
                                    {{ item.machine.name }}
                                </a>
                            </td>
                            <td style="font-size: 12px;">
                                {% if item.machine.status == 'working' %}
                                    <span style="color: #28a745;">üü¢ –†–∞–±–æ—Ç–∞–µ—Ç</span>
                                {% elif item.machine.status == 'maintenance' %}
                                    <span style="color: #ffc107;">üü° –†–µ–º–æ–Ω—Ç</span>
                                {% elif item.machine.status == 'stopped' %}
                                    <span style="color: #dc3545;">üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                                {% else %}
                                    <span style="color: #6c757d;">‚ö™ –ü—Ä–æ—Å—Ç–æ–π</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 12px;" class="operator-name">
                                {% if item.machine.current_operator %}
                                    {{ item.machine.current_operator.get_full_name }}
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 12px; text-align: right;" class="meters-value">
                                {{ item.machine.current_meters|floatformat:4 }}
                            </td>
                            <td style="font-size: 12px; text-align: center;" class="call-status">
                                {% if item.active_call %}
                                    {% if item.active_call.status == 'pending' %}
                                        <span style="color: #dc3545; font-weight: 600;">‚ö†Ô∏è –î–∞</span>
                                    {% elif item.active_call.status == 'in_progress' %}
                                        <span style="color: #ffc107; font-weight: 600;">üîß –í —Ä–∞–±–æ—Ç–µ</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #28a745;">‚úì –ù–µ—Ç</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 12px;" class="master-name">
                                {% if item.active_call and item.active_call.master %}
                                    {{ item.active_call.master.get_full_name }}
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999; padding: 30px; font-size: 13px;">
                                –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card" style="margin-top: 15px;">
        <div class="lohia-card-body" style="padding: 15px;">
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:shifts_history' %}" class="lohia-nav-btn lohia-nav-btn-outline" style="font-size: 12px; padding: 8px 15px;">
                    üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
                </a>
                <a href="{% url 'lohia_monitor:maintenance_history' %}" class="lohia-nav-btn lohia-nav-btn-outline" style="font-size: 12px; padding: 8px 15px;">
                    üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
                </a>
                <a href="{% url 'lohia_monitor:machine_stats' %}" class="lohia-nav-btn lohia-nav-btn-outline" style="font-size: 12px; padding: 8px 15px;">
                    üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>


<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/dashboard/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
    updateWebSocketStatus('connecting');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Lohia dashboard');
        updateWebSocketStatus('connected');
        reconnectAttempts = 0;
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û machine_status - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (data.type === 'machine_status' && Array.isArray(data.data)) {
                console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞–Ω–∫–æ–≤');
                updateAllMachines(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected');
        lohiaSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function updateAllMachines(machines) {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', machines.length, '—Å—Ç–∞–Ω–∫–æ–≤');
    
    machines.forEach(machineData => {
        const row = document.querySelector(`.machine-row[data-machine-id="${machineData.machine_id}"]`);
        if (!row) {
            console.warn('‚ö†Ô∏è –°—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Å—Ç–∞–Ω–∫–∞ ID:', machineData.machine_id);
            return;
        }
        
        console.log(`üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞ ${machineData.name}:`, machineData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        const statusCell = row.querySelector('td:nth-child(3)');
        if (statusCell) {
            let statusHtml = '';
            if (machineData.status === 'working') {
                statusHtml = '<span style="color: #28a745;">üü¢ –†–∞–±–æ—Ç–∞–µ—Ç</span>';
            } else if (machineData.status === 'maintenance') {
                statusHtml = '<span style="color: #ffc107;">üü° –†–µ–º–æ–Ω—Ç</span>';
            } else if (machineData.status === 'stopped') {
                statusHtml = '<span style="color: #dc3545;">üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>';
            } else {
                statusHtml = '<span style="color: #6c757d;">‚ö™ –ü—Ä–æ—Å—Ç–æ–π</span>';
            }
            statusCell.innerHTML = statusHtml;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
        const operatorCell = row.querySelector('.operator-name');
        if (operatorCell) {
            if (machineData.current_operator && machineData.current_operator !== null && machineData.current_operator !== 'null') {
                operatorCell.innerHTML = machineData.current_operator;
                operatorCell.style.color = '#000';
                console.log(`üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è ${machineData.name}: ${machineData.current_operator}`);
            } else {
                operatorCell.innerHTML = '<span style="color: #999;">‚Äî</span>';
                console.log(`üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è ${machineData.name}: –ù–ï–¢ (–æ—á–∏—â–µ–Ω)`);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∞–∂ - –ö–†–ò–¢–ò–ß–ù–û!
        const metersCell = row.querySelector('.meters-value');
        if (metersCell) {
            const oldValue = metersCell.textContent;
            // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ—á–Ω–æ —á–∏—Å–ª–æ
            const metersValue = parseFloat(machineData.current_meters);
            const newValue = (isNaN(metersValue) ? 0 : metersValue).toFixed(4);  // 4 –∑–Ω–∞–∫–∞!
            metersCell.textContent = newValue;
            
            if (oldValue !== newValue) {
                console.log(`‚úÖ –ú–µ—Ç—Ä–∞–∂ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è ${machineData.name}: ${oldValue} ‚Üí ${newValue} –º`);
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                metersCell.style.background = '#fff3cd';
                setTimeout(() => {
                    metersCell.style.background = '';
                }, 1000);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
        const callCell = row.querySelector('.call-status');
        if (callCell) {
            let callHtml = '<span style="color: #28a745;">‚úì –ù–µ—Ç</span>';
            if (machineData.call_status === 'pending') {
                callHtml = '<span style="color: #dc3545; font-weight: 600;">‚ö†Ô∏è –î–∞</span>';
            } else if (machineData.call_status === 'in_progress') {
                callHtml = '<span style="color: #ffc107; font-weight: 600;">üîß –í —Ä–∞–±–æ—Ç–µ</span>';
            }
            callCell.innerHTML = callHtml;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Å—Ç–µ—Ä–∞
        const masterCell = row.querySelector('.master-name');
        if (masterCell) {
            if (machineData.master) {
                masterCell.textContent = machineData.master;
                masterCell.style.color = '#000';
            } else {
                masterCell.innerHTML = '<span style="color: #999;">‚Äî</span>';
            }
        }
    });
}


// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lohia dashboard —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
});
</script>
{% endblock %}
