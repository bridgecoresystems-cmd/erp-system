{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title %}–î–∞—à–±–æ—Ä–¥ —Å—Ç–∞–Ω–∫–∞ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <div class="lohia-card">
        <div class="lohia-card-header">
            üè≠ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞–Ω–∫–∞ Lohia
            <div id="websocket-status" style="float: right; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–∞ -->
    <div class="lohia-grid lohia-grid-3">
        <div class="lohia-card">
            <div class="lohia-card-header">
                üìä –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–∞
            </div>
            <div class="lohia-card-body">
                    {% if machine %}
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div class="lohia-status-indicator 
                                {% if machine.status == 'working' %}lohia-status-working
                                {% elif machine.status == 'maintenance' %}lohia-status-maintenance
                                {% elif machine.status == 'stopped' %}lohia-status-stopped
                                {% else %}lohia-status-idle{% endif %}">
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 18px;">{{ machine.name }}</h4>
                                <p style="margin: 0; color: #666; font-size: 14px;">
                                    {% if machine.status == 'working' %}üü¢ –†–∞–±–æ—Ç–∞–µ—Ç
                                    {% elif machine.status == 'maintenance' %}üü° –í —Ä–µ–º–æ–Ω—Ç–µ
                                    {% elif machine.status == 'stopped' %}üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                                    {% else %}‚ö™ –ü—Ä–æ—Å—Ç–æ–π{% endif %}
                                </p>
                            </div>
                        </div>
                        
                        {% if machine.current_operator %}
                            <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> <span class="current-operator">{{ machine.current_operator.get_full_name }}</span></p>
                        {% else %}
                            <p class="text-muted current-operator">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>
                        {% endif %}
                        
                        <p><strong>–ò–º–ø—É–ª—å—Å—ã:</strong> <span class="current-pulses">{{ machine.current_pulse_count }}</span></p>
                        <p><strong>–ú–µ—Ç—Ä–∞–∂:</strong> <span class="current-meters">{{ machine.current_meters|floatformat:6 }} –º</span></p>
                        <p><strong>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:</strong> {{ machine.meters_per_pulse|floatformat:6 }} –º/–∏–º–ø—É–ª—å—Å</p>
                    {% else %}
                        <p class="text-muted">–°—Ç–∞–Ω–æ–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ -->
        <div class="lohia-card">
            <div class="lohia-card-header">
                ‚è∞ –ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞
            </div>
            <div class="lohia-card-body">
                    {% if active_shift %}
                        <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {{ active_shift.operator.get_full_name }}</p>
                        <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ active_shift.start_time|localtime|date:"H:i" }}</p>
                        <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> <span class="shift-duration">{{ active_shift.duration_hours|floatformat:1 }} —á</span></p>
                        <p><strong>–ò–º–ø—É–ª—å—Å—ã:</strong> <span class="shift-pulses">{{ active_shift.total_pulses }}</span></p>
                        <p><strong>–ú–µ—Ç—Ä–∞–∂:</strong> <span class="shift-meters">{{ active_shift.total_meters|floatformat:6 }} –º</span></p>
                    {% else %}
                        <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞ -->
        <div class="lohia-card">
            <div class="lohia-card-header">
                üîß –í—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
            </div>
            <div class="lohia-card-body call-status">
                    {% if active_call %}
                        <div class="alert alert-warning">
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                {% if active_call.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞
                                {% elif active_call.status == 'in_progress' %}üîß –í —Ä–∞–±–æ—Ç–µ
                                {% else %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω{% endif %}
                            </p>
                            <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {{ active_call.operator.get_full_name }}</p>
                            <p><strong>–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞:</strong> {{ active_call.call_time|localtime|date:"H:i" }}</p>
                            
                            {% if active_call.master %}
                                <p><strong>–ú–∞—Å—Ç–µ—Ä:</strong> {{ active_call.master.get_full_name }}</p>
                            {% endif %}
                            
                            {% if active_call.response_time %}
                                <p><strong>–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏:</strong> {{ active_call.response_time }}</p>
                            {% endif %}
                            
                            {% if active_call.repair_time %}
                                <p><strong>–í—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞:</strong> {{ active_call.repair_time }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-success">‚úÖ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –∏–º–ø—É–ª—å—Å–æ–≤ -->
    <div class="lohia-card">
        <div class="lohia-card-header">
            üìà –ì—Ä–∞—Ñ–∏–∫ –∏–º–ø—É–ª—å—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π)
        </div>
        <div class="lohia-card-body">
            {% if recent_pulses %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table">
                                <thead>
                                    <tr>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–ò–º–ø—É–ª—å—Å—ã</th>
                                        <th>–í—Å–µ–≥–æ –∏–º–ø—É–ª—å—Å–æ–≤</th>
                                        <th>–ú–µ—Ç—Ä–∞–∂</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pulse in recent_pulses %}
                                    <tr>
                                        <td>{{ pulse.timestamp|localtime|date:"H:i:s" }}</td>
                                        <td>{{ pulse.pulse_count }}</td>
                                        <td>{{ pulse.total_pulses }}</td>
                                        <td>{{ pulse.meters_produced|floatformat:6 }} –º</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–º–ø—É–ª—å—Å–∞—Ö</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card">
        <div class="lohia-card-body">
            <h5 style="margin-bottom: 15px; text-align: center;">üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:shifts_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
                </a>
                <a href="{% url 'lohia_monitor:maintenance_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
                </a>
                <a href="{% url 'lohia_monitor:machine_stats' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>


<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/machine1/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
    updateWebSocketStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Lohia monitor');
        updateWebSocketStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
        reconnectAttempts = 0;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        requestInitialData();
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            if (data.type === 'machine_status') {
                updateMachineStatus(data.data);
            } else if (data.type === 'shift_data') {
                updateActiveShift(data.data);
            } else if (data.type === 'pulse_data') {
                updatePulseData(data.data);
            } else if (data.type === 'machine_update') {
                updateMachineStatus(data.data);
            } else if (data.type === 'shift_update') {
                updateActiveShift(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        lohiaSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            // Fallback –Ω–∞ AJAX
            startAjaxFallback();
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function requestInitialData() {
    if (lohiaSocket && lohiaSocket.readyState === WebSocket.OPEN) {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
        lohiaSocket.send(JSON.stringify({type: 'get_machine_status'}));
        lohiaSocket.send(JSON.stringify({type: 'get_shift_data'}));
        lohiaSocket.send(JSON.stringify({type: 'get_pulse_data'}));
    }
}

// Fallback –Ω–∞ AJAX –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX fallback');
    updateInterval = setInterval(updateDashboard, 5000);
}

async function updateDashboard() {
    try {
        const response = await fetch('/lohia/api/dashboard-status/');
        const data = await response.json();
        
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–∞
            updateMachineStatus(data.machine);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É
            updateActiveShift(data.active_shift);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
            updateMaintenanceCall(data.active_call);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞:', error);
    }
}

function updateMachineStatus(machine) {
    if (!machine) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∏–º–ø—É–ª—å—Å—ã, –º–µ—Ç—Ä–∞–∂
    const operatorEl = document.querySelector('.current-operator');
    const pulsesEl = document.querySelector('.current-pulses');
    const metersEl = document.querySelector('.current-meters');
    
    if (operatorEl) {
        operatorEl.textContent = machine.current_operator || '–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞';
    }
    
    if (pulsesEl) {
        pulsesEl.textContent = machine.current_pulse_count;
    }
    
    if (metersEl) {
        metersEl.textContent = machine.current_meters.toFixed(6) + ' –º';
    }
}

function updateActiveShift(shift) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã
    if (shift) {
        const durationEl = document.querySelector('.shift-duration');
        const shiftPulsesEl = document.querySelector('.shift-pulses');
        const shiftMetersEl = document.querySelector('.shift-meters');
        
        if (durationEl) durationEl.textContent = shift.duration_hours.toFixed(1) + ' —á';
        if (shiftPulsesEl) shiftPulsesEl.textContent = shift.total_pulses;
        if (shiftMetersEl) shiftMetersEl.textContent = shift.total_meters.toFixed(6) + ' –º';
    }
}

function updateMaintenanceCall(call) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—ã–∑–æ–≤–∞ –º–∞—Å—Ç–µ—Ä–∞
    const callStatusEl = document.querySelector('.call-status');
    
    if (call) {
        if (callStatusEl) {
            callStatusEl.innerHTML = `
                <div class="alert alert-warning">
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${call.status_display}</p>
                    <p><strong>–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞:</strong> ${call.call_time}</p>
                    ${call.master ? `<p><strong>–ú–∞—Å—Ç–µ—Ä:</strong> ${call.master}</p>` : ''}
                </div>
            `;
        }
    } else {
        if (callStatusEl) {
            callStatusEl.innerHTML = '<p class="text-success">‚úÖ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>';
        }
    }
}

function updatePulseData(pulseData) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—É–ª—å—Å–∞—Ö
    if (pulseData && Array.isArray(pulseData)) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—É–ª—å—Å–æ–≤
        console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø—É–ª—å—Å–æ–≤:', pulseData.length, '–∑–∞–ø–∏—Å–µ–π');
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lohia dashboard —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}
