{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title %}{{ machine.name }} - –î–µ—Ç–∞–ª–∏{% endblock %}

{% block content %}
<div class="lohia-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="lohia-card" style="margin-bottom: 15px;">
        <div class="lohia-card-header">
            <a href="{% url 'lohia_monitor:dashboard' %}" style="color: #fff; text-decoration: none; margin-right: 15px;">
                ‚Üê –ù–∞–∑–∞–¥
            </a>
            üè≠ {{ machine.name }} - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            <div id="websocket-status" style="float: right; font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">
                üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="lohia-grid lohia-grid-3">
        <!-- –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–∞ -->
        <div class="lohia-card">
            <div class="lohia-card-header">
                üìä –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–∞
            </div>
            <div class="lohia-card-body">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div class="lohia-status-indicator 
                        {% if machine.status == 'working' %}lohia-status-working
                        {% elif machine.status == 'maintenance' %}lohia-status-maintenance
                        {% elif machine.status == 'stopped' %}lohia-status-stopped
                        {% else %}lohia-status-idle{% endif %}">
                    </div>
                    <div>
                        <h4 style="margin: 0; font-size: 16px;">{{ machine.name }}</h4>
                        <p style="margin: 0; color: #666; font-size: 13px;" class="machine-status-text">
                            {% if machine.status == 'working' %}üü¢ –†–∞–±–æ—Ç–∞–µ—Ç
                            {% elif machine.status == 'maintenance' %}üü° –í —Ä–µ–º–æ–Ω—Ç–µ
                            {% elif machine.status == 'stopped' %}üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                            {% else %}‚ö™ –ü—Ä–æ—Å—Ç–æ–π{% endif %}
                        </p>
                    </div>
                </div>
                
                <p style="font-size: 13px;"><strong>ESP32 ID:</strong> {{ machine.esp32_id }}</p>
                
                {% if machine.current_operator %}
                    <p style="font-size: 13px;"><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> <span class="current-operator">{{ machine.current_operator.get_full_name }}</span></p>
                {% else %}
                    <p style="font-size: 13px;" class="text-muted current-operator">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>
                {% endif %}
                
                <p style="font-size: 13px;"><strong>–ò–º–ø—É–ª—å—Å—ã:</strong> <span class="current-pulses">{{ machine.current_pulse_count }}</span></p>
                <p style="font-size: 13px;"><strong>–ú–µ—Ç—Ä–∞–∂:</strong> <span class="current-meters">{{ machine.current_meters|floatformat:4 }} –º</span></p>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞ -->
        <div class="lohia-card">
            <div class="lohia-card-header">
                üîß –í—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
            </div>
            <div class="lohia-card-body call-status">
                {% if active_call %}
                    <div class="alert alert-warning" style="padding: 10px; background: #fff3cd; border-radius: 6px;">
                        <p style="font-size: 13px; margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            {% if active_call.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞
                            {% elif active_call.status == 'in_progress' %}üîß –í —Ä–∞–±–æ—Ç–µ
                            {% else %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω{% endif %}
                        </p>
                        <p style="font-size: 13px; margin: 5px 0;"><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {{ active_call.operator.get_full_name }}</p>
                        <p style="font-size: 13px; margin: 5px 0;"><strong>–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞:</strong> {{ active_call.call_time|localtime|date:"H:i" }}</p>
                        
                        {% if active_call.master %}
                            <p style="font-size: 13px; margin: 5px 0;"><strong>–ú–∞—Å—Ç–µ—Ä:</strong> {{ active_call.master.get_full_name }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-success" style="font-size: 13px;">‚úÖ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∞–Ω–∫–∞ -->
    <div class="lohia-card" style="margin-top: 15px;">
        <div class="lohia-card-header">
            ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∞–Ω–∫–∞
        </div>
        <div class="lohia-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">Transmit Pulse</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.transmit_pulse }}</p>
                </div>
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">Gear Box Ratio</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.gear_box_ratio }}</p>
                </div>
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">Sprocket Gear Box</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.sprocket_gear_box }}</p>
                </div>
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">Sprocket Takeup Roller</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.sprocket_takeup_roller }}</p>
                </div>
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">Roller Diameter (cm)</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.roller_diameter_cm }}</p>
                </div>
                <div>
                    <p style="font-size: 12px; color: #666; margin: 0;">–ú–µ—Ç—Ä–æ–≤ –∑–∞ –∏–º–ø—É–ª—å—Å</p>
                    <p style="font-size: 14px; font-weight: 600; margin: 5px 0;">{{ machine.meters_per_pulse|floatformat:6 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–º–µ–Ω—ã -->
    <div class="lohia-card" style="margin-top: 15px;">
        <div class="lohia-card-header">
            üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–º–µ–Ω—ã (5 –∑–∞–ø–∏—Å–µ–π)
        </div>
        <div class="lohia-card-body">
            {% if recent_shifts %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table lohia-table-compact">
                        <thead>
                            <tr>
                                <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                <th>–ù–∞—á–∞–ª–æ</th>
                                <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                <th>–ú–µ—Ç—Ä–∞–∂</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="recent-shifts-table">
                            {% for shift in recent_shifts %}
                            <tr>
                                <td>{{ shift.operator.get_full_name }}</td>
                                <td>{{ shift.start_time|localtime|date:"d.m H:i" }}</td>
                                <td>
                                    {% if shift.end_time %}
                                        {{ shift.end_time|localtime|date:"d.m H:i" }}
                                    {% else %}
                                        <span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                    {% endif %}
                                </td>
                                <td>{{ shift.get_duration_display }}</td>
                                <td>{{ shift.total_meters|floatformat:2 }} –º</td>
                                <td>
                                    {% if shift.status == 'active' %}
                                        <span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                    {% else %}
                                        <span style="color: #6c757d;">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted" style="font-size: 13px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö</p>
            {% endif %}
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∑–æ–≤—ã –º–∞—Å—Ç–µ—Ä–∞ -->
    <div class="lohia-card" style="margin-top: 15px;">
        <div class="lohia-card-header">
            üîß –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∑–æ–≤—ã –º–∞—Å—Ç–µ—Ä–∞ (5 –∑–∞–ø–∏—Å–µ–π)
        </div>
        <div class="lohia-card-body">
            {% if recent_calls %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table lohia-table-compact">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞</th>
                                <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                <th>–ú–∞—Å—Ç–µ—Ä</th>
                                <th>–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏</th>
                                <th>–í—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="recent-calls-table">
                            {% for call in recent_calls %}
                            <tr>
                                <td>{{ call.call_time|localtime|date:"d.m H:i" }}</td>
                                <td>{{ call.operator.get_full_name }}</td>
                                <td>
                                    {% if call.master %}
                                        {{ call.master.get_full_name }}
                                    {% else %}
                                        <span style="color: #999;">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>{{ call.get_response_time_display }}</td>
                                <td>{{ call.get_repair_time_display }}</td>
                                <td>
                                    {% if call.status == 'pending' %}
                                        <span style="color: #dc3545;">–û–∂–∏–¥–∞–µ—Ç</span>
                                    {% elif call.status == 'in_progress' %}
                                        <span style="color: #ffc107;">–í —Ä–∞–±–æ—Ç–µ</span>
                                    {% else %}
                                        <span style="color: #28a745;">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted" style="font-size: 13px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–∑–æ–≤–∞—Ö –º–∞—Å—Ç–µ—Ä–∞</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// ========== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –í–†–ï–ú–ï–ù–ò ==========
function formatDuration(hours) {
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —á–∞—Å–æ–≤ –≤ "X —á Y –º–∏–Ω"
     * @param {number} hours - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∞—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä 8.5)
     * @returns {string} - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "8 —á 30 –º–∏–Ω")
     */
    if (!hours || hours === 0) return '‚Äî';
    
    const totalMinutes = Math.round(hours * 60);
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    
    if (h > 0 && m > 0) {
        return `${h} —á ${m} –º–∏–Ω`;
    } else if (h > 0) {
        return `${h} —á`;
    } else {
        return `${m} –º–∏–Ω`;
    }
}

// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;
const machineId = {{ machine.id }};

function updateWebSocketStatus(status) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –æ–±—â–µ–º—É –∫–∞–Ω–∞–ª—É dashboard
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/dashboard/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket (–æ–±—â–∏–π –∫–∞–Ω–∞–ª):', wsUrl);
    updateWebSocketStatus('connecting');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å—Ç–∞–Ω–∫—É');
        updateWebSocketStatus('connected');
        reconnectAttempts = 0;
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç WebSocket');
            
            if (data.type === 'machine_status' && Array.isArray(data.data)) {
                // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –ù–ê–®–ï–ô –º–∞—à–∏–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ
                updateMachineData(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected');
        lohiaSocket = null;
        
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts}`);
            setTimeout(connectWebSocket, reconnectDelay);
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
function loadMachineDetails() {
    console.log(`üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–∫–∞ #${machineId} —á–µ—Ä–µ–∑ API`);
    
    fetch(`/lohia/api/machine/${machineId}/detail/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${data.shifts.length} —Å–º–µ–Ω, ${data.calls.length} –≤—ã–∑–æ–≤–æ–≤`);
                updateRecentShifts(data.shifts);
                updateRecentCalls(data.calls);
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–º–µ–Ω
function updateRecentShifts(shifts) {
    const tbody = document.getElementById('recent-shifts-table');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    shifts.forEach(shift => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${shift.operator}</td>
            <td>${shift.start_time}</td>
            <td>${shift.end_time || '<span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>'}</td>
            <td>${shift.duration}</td>
            <td>${shift.total_meters.toFixed(2)} –º</td>
            <td>${shift.status === 'active' ? '<span style="color: #28a745;">–ê–∫—Ç–∏–≤–Ω–∞</span>' : '<span style="color: #6c757d;">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>'}</td>
        `;
        tbody.appendChild(row);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤—ã–∑–æ–≤–æ–≤
function updateRecentCalls(calls) {
    const tbody = document.getElementById('recent-calls-table');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    calls.forEach(call => {
        const row = document.createElement('tr');
        
        let statusHtml = '';
        if (call.status === 'pending') {
            statusHtml = '<span style="color: #dc3545;">–û–∂–∏–¥–∞–µ—Ç</span>';
        } else if (call.status === 'in_progress') {
            statusHtml = '<span style="color: #ffc107;">–í —Ä–∞–±–æ—Ç–µ</span>';
        } else {
            statusHtml = '<span style="color: #28a745;">–ó–∞–≤–µ—Ä—à–µ–Ω</span>';
        }
        
        row.innerHTML = `
            <td>${call.call_time}</td>
            <td>${call.operator}</td>
            <td>${call.master || '<span style="color: #999;">‚Äî</span>'}</td>
            <td>${call.response_time}</td>
            <td>${call.repair_time}</td>
            <td>${statusHtml}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateMachineData(machines) {
    if (!Array.isArray(machines)) return;
    
    // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –ù–ê–®–ï–ô –º–∞—à–∏–Ω—ã
    const machineData = machines.find(m => m.machine_id === machineId);
    if (!machineData) {
        console.warn(`‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–Ω–∫–∞ #${machineId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
        return;
    }
    
    console.log(`üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–∫–∞ #${machineId}:`, machineData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    const statusText = document.querySelector('.machine-status-text');
    if (statusText) {
        let statusHtml = '';
        if (machineData.status === 'working') {
            statusHtml = 'üü¢ –†–∞–±–æ—Ç–∞–µ—Ç';
        } else if (machineData.status === 'maintenance') {
            statusHtml = 'üü° –í —Ä–µ–º–æ–Ω—Ç–µ';
        } else if (machineData.status === 'stopped') {
            statusHtml = 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
        } else {
            statusHtml = '‚ö™ –ü—Ä–æ—Å—Ç–æ–π';
        }
        statusText.innerHTML = statusHtml;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    const operatorEl = document.querySelector('.current-operator');
    if (operatorEl) {
        if (machineData.current_operator || machineData.operator) {
            operatorEl.textContent = machineData.current_operator || machineData.operator;
            operatorEl.style.color = '#000';
        } else {
            operatorEl.innerHTML = '<span class="text-muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>';
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–ø—É–ª—å—Å—ã
    const pulsesEl = document.querySelector('.current-pulses');
    if (pulsesEl) {
        pulsesEl.textContent = machineData.current_pulse_count || 0;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∞–∂
    const metersEl = document.querySelector('.current-meters');
    if (metersEl) {
        const meters = parseFloat(machineData.current_meters || machineData.meters || 0);
        metersEl.textContent = meters.toFixed(4) + ' –º';  // 4 –∑–Ω–∞–∫–∞!
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
    const callStatus = document.querySelector('.call-status');
    if (callStatus) {
        let callHtml = '<p class="text-success" style="font-size: 13px;">‚úÖ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>';
        
        if (machineData.call_status) {
            let statusText = '';
            if (machineData.call_status === 'pending') {
                statusText = '‚è≥ –û–∂–∏–¥–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞';
            } else if (machineData.call_status === 'in_progress') {
                statusText = 'üîß –í —Ä–∞–±–æ—Ç–µ';
            } else {
                statusText = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω';
            }
            
            callHtml = `
                <div class="alert alert-warning" style="padding: 10px; background: #fff3cd; border-radius: 6px;">
                    <p style="font-size: 13px; margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusText}</p>
                    ${machineData.master ? `<p style="font-size: 13px; margin: 5px 0;"><strong>–ú–∞—Å—Ç–µ—Ä:</strong> ${machineData.master}</p>` : ''}
                </div>
            `;
        }
        
        callStatus.innerHTML = callHtml;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–º–µ–Ω—ã –∏ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ API
    loadMachineDetails();
}

// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log(`üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞–Ω–∫–∞ #${machineId} —Å WebSocket`);
    
    // 1. –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ —á–µ—Ä–µ–∑ API
    loadMachineDetails();
    
    // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
});
</script>
{% endblock %}

