{% extends 'base.html' %}
{% load tz %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç–∞–Ω–∫–∞ - –°—Ç–∞–Ω–æ–∫ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <div class="lohia-card">
        <div class="lohia-card-header">
            üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Ç–∞–Ω–∫–∞
        </div>
    </div>

    {% if machine %}
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="lohia-grid lohia-grid-4">
        <div class="lohia-stat-card">
            <div class="lohia-stat-number">{{ total_shifts }}</div>
            <div class="lohia-stat-label">üìä –í—Å–µ–≥–æ —Å–º–µ–Ω</div>
        </div>
        <div class="lohia-stat-card">
            <div class="lohia-stat-number">{{ total_meters|floatformat:0 }} –º</div>
            <div class="lohia-stat-label">üìè –û–±—â–∏–π –º–µ—Ç—Ä–∞–∂</div>
        </div>
        <div class="lohia-stat-card">
            <div class="lohia-stat-number">{{ total_calls }}</div>
            <div class="lohia-stat-label">üîß –í—ã–∑–æ–≤–æ–≤ –º–∞—Å—Ç–µ—Ä–∞</div>
        </div>
        <div class="lohia-stat-card">
            <div class="lohia-stat-number">
                {% if avg_response_time %}
                    {{ avg_response_time|floatformat:1 }} –º–∏–Ω
                {% else %}
                    ‚Äî
                {% endif %}
            </div>
            <div class="lohia-stat-label">‚è±Ô∏è –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏</div>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞–Ω–∫–µ -->
    <div class="lohia-card">
        <div class="lohia-card-header">
            üè≠ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞–Ω–∫–µ
            <div id="websocket-status" style="float: right; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">
                üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
        </div>
        <div class="lohia-card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div>
                    <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ machine.name }}</p>
                    <p><strong>ID ESP32:</strong> {{ machine.esp32_id }}</p>
                    <p><strong>–ú–µ—Ç—Ä–æ–≤ –∑–∞ –∏–º–ø—É–ª—å—Å:</strong> {{ machine.meters_per_pulse|floatformat:6 }}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                        {% if machine.status == 'working' %}üü¢ –†–∞–±–æ—Ç–∞–µ—Ç
                        {% elif machine.status == 'maintenance' %}üü° –í —Ä–µ–º–æ–Ω—Ç–µ
                        {% elif machine.status == 'stopped' %}üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                        {% else %}‚ö™ –ü—Ä–æ—Å—Ç–æ–π{% endif %}
                    </p>
                </div>
                <div>
                    <h6 style="margin-bottom: 10px; color: #667eea;">üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–∞–Ω–∫–∞:</h6>
                    <p><strong>Transmit Pulse:</strong> {{ machine.transmit_pulse }}</p>
                    <p><strong>Gear box ratio:</strong> {{ machine.gear_box_ratio }}</p>
                    <p><strong>Sprocket gear box:</strong> {{ machine.sprocket_gear_box }}</p>
                    <p><strong>Sprocket takeup roller:</strong> {{ machine.sprocket_takeup_roller }}</p>
                    <p><strong>Roller diameter:</strong> {{ machine.roller_diameter_cm }} —Å–º</p>
                    <p><strong>P-Ctrl. Ampl.:</strong> {{ machine.p_ctrl_ampl }}</p>
                </div>
                <div>
                    <p><strong>–¢–µ–∫—É—â–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä:</strong> 
                        {% if machine.current_operator %}
                            {{ machine.current_operator.get_full_name }}
                        {% else %}
                            <span class="text-muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>
                        {% endif %}
                    </p>
                    <p><strong>–¢–µ–∫—É—â–∏–µ –∏–º–ø—É–ª—å—Å—ã:</strong> {{ machine.current_pulse_count }}</p>
                    <p><strong>–¢–µ–∫—É—â–∏–π –º–µ—Ç—Ä–∞–∂:</strong> {{ machine.current_meters|floatformat:2 }} –º</p>
                    <p><strong>–ê–∫—Ç–∏–≤–µ–Ω:</strong> 
                        {% if machine.is_active %}
                            <span class="text-success">‚úÖ –î–∞</span>
                        {% else %}
                            <span class="text-danger">‚ùå –ù–µ—Ç</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <div class="lohia-card">
        <div class="lohia-card-header">
            üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        </div>
        <div class="lohia-card-body">
            <div class="lohia-grid lohia-grid-3">
                <div class="lohia-stat-card">
                    <div class="lohia-stat-number">
                        {% if total_shifts > 0 %}
                            {{ avg_meters_per_shift|floatformat:0 }} –º/—Å–º–µ–Ω–∞
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                    <div class="lohia-stat-label">–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞ —Å–º–µ–Ω—É</div>
                </div>
                <div class="lohia-stat-card">
                    <div class="lohia-stat-number">{{ machine.meters_per_pulse|floatformat:6 }} –º/–∏–º–ø—É–ª—å—Å</div>
                    <div class="lohia-stat-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—á–µ—Ç–∞</div>
                </div>
                <div class="lohia-stat-card">
                    <div class="lohia-stat-number">
                        {% if total_shifts > 0 %}
                            {{ calls_per_shift|floatformat:2 }} –≤—ã–∑–æ–≤–æ–≤/—Å–º–µ–Ω—É
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </div>
                    <div class="lohia-stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="lohia-card">
        <div class="lohia-card-body">
            <div style="text-align: center; padding: 40px;">
                <h4 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è –°—Ç–∞–Ω–æ–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</h4>
                <p style="color: #666;">–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–∞–Ω–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card">
        <div class="lohia-card-body">
            <h5 style="margin-bottom: 15px; text-align: center;">üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:dashboard' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üè† –î–∞—à–±–æ—Ä–¥
                </a>
                <a href="{% url 'lohia_monitor:shifts_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
                </a>
                <a href="{% url 'lohia_monitor:maintenance_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
let updateInterval = null;
let lastUpdateTime = null;

function updateStatus(status) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'ok') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            const timeAgo = lastUpdateTime ? Math.round((Date.now() - lastUpdateTime) / 1000) : 0;
            statusEl.innerHTML = `üü¢ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${timeAgo}—Å –Ω–∞–∑–∞–¥`;
        } else if (status === 'updating') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        }
    }
}

function updateStats() {
    updateStatus('updating');
    
    fetch('/lohia/api/machine-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.querySelector('.lohia-stat-card:nth-child(1) .lohia-stat-number').textContent = data.total_shifts;
                document.querySelector('.lohia-stat-card:nth-child(2) .lohia-stat-number').textContent = Math.round(data.total_meters) + ' –º';
                document.querySelector('.lohia-stat-card:nth-child(3) .lohia-stat-number').textContent = data.total_calls;
                
                const avgResponseEl = document.querySelector('.lohia-stat-card:nth-child(4) .lohia-stat-number');
                if (data.avg_response_time) {
                    avgResponseEl.textContent = data.avg_response_time + ' –º–∏–Ω';
                } else {
                    avgResponseEl.textContent = '‚Äî';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–∫–∞
                const currentOperatorEl = document.querySelector('.lohia-card-body p:nth-child(1) strong + *');
                if (currentOperatorEl) {
                    if (data.current_operator) {
                        currentOperatorEl.textContent = data.current_operator;
                        currentOperatorEl.className = '';
                    } else {
                        currentOperatorEl.innerHTML = '<span class="text-muted">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>';
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–ø—É–ª—å—Å—ã –∏ –º–µ—Ç—Ä–∞–∂
                const pulsesEl = document.querySelector('.lohia-card-body div > div:nth-child(3) p:nth-child(2) strong');
                if (pulsesEl && pulsesEl.nextSibling) {
                    pulsesEl.nextSibling.textContent = ' ' + data.current_pulse_count;
                }
                
                const metersEl = document.querySelector('.lohia-card-body div > div:nth-child(3) p:nth-child(3) strong');
                if (metersEl && metersEl.nextSibling) {
                    metersEl.nextSibling.textContent = ' ' + data.current_meters.toFixed(4) + ' –º';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                const avgMetersPerShiftEl = document.querySelector('.lohia-grid-3 .lohia-stat-card:nth-child(1) .lohia-stat-number');
                if (avgMetersPerShiftEl) {
                    if (data.total_shifts > 0) {
                        avgMetersPerShiftEl.textContent = data.avg_meters_per_shift + ' –º/—Å–º–µ–Ω–∞';
                    } else {
                        avgMetersPerShiftEl.textContent = '‚Äî';
                    }
                }
                
                const callsPerShiftEl = document.querySelector('.lohia-grid-3 .lohia-stat-card:nth-child(3) .lohia-stat-number');
                if (callsPerShiftEl) {
                    if (data.total_shifts > 0) {
                        callsPerShiftEl.textContent = data.calls_per_shift + ' –≤—ã–∑–æ–≤–æ–≤/—Å–º–µ–Ω—É';
                    } else {
                        callsPerShiftEl.textContent = '‚Äî';
                    }
                }
                
                lastUpdateTime = Date.now();
                updateStatus('ok');
                console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞:', data.error);
                updateStatus('error');
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            updateStatus('error');
        });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (AJAX)');
    
    // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateStats();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    updateInterval = setInterval(updateStats, 30000);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ —Å—Ç–∞—Ç—É—Å–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(() => {
        if (lastUpdateTime) {
            updateStatus('ok');
        }
    }, 1000);
});

window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}
