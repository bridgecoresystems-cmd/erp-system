{% extends 'base.html' %}
{% load tz %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤ –º–∞—Å—Ç–µ—Ä–∞ - –°—Ç–∞–Ω–æ–∫ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <div class="lohia-card">
        <div class="lohia-card-header">
            üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
            <div id="websocket-status" style="float: right; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
            </div>
        </div>
    </div>

    <div class="lohia-card">
        <div class="lohia-card-header">
            –í—Å–µ –≤—ã–∑–æ–≤—ã
        </div>
        <div class="lohia-card-body">
            {% if calls %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–í—Ä–µ–º—è –≤—ã–∑–æ–≤–∞</th>
                                        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                        <th>–ú–∞—Å—Ç–µ—Ä</th>
                                        <th>–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏</th>
                                        <th>–í—Ä–µ–º—è —Ä–µ–º–æ–Ω—Ç–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenance-table-body">
                                    {% for call in calls %}
                                    <tr>
                                        <td>{{ call.call_time|localtime|date:"d.m.Y" }}</td>
                                        <td>{{ call.call_time|localtime|date:"H:i" }}</td>
                                        <td>{{ call.operator.get_full_name }}</td>
                                        <td>
                                            {% if call.master %}
                                                {{ call.master.get_full_name }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if call.response_time %}
                                                {{ call.response_time }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if call.repair_time %}
                                                {{ call.repair_time }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if call.status == 'pending' %}
                                                <span class="lohia-badge lohia-badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                                            {% elif call.status == 'in_progress' %}
                                                <span class="lohia-badge lohia-badge-info">–í —Ä–∞–±–æ—Ç–µ</span>
                                            {% else %}
                                                <span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if call.description %}
                                                {{ call.description|truncatechars:50 }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
            {% else %}
                <p style="text-align: center; color: #666; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–∑–æ–≤–∞—Ö –º–∞—Å—Ç–µ—Ä–∞</p>
            {% endif %}
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card">
        <div class="lohia-card-body">
            <h5 style="margin-bottom: 15px; text-align: center;">üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:dashboard' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üè† –î–∞—à–±–æ—Ä–¥
                </a>
                <a href="{% url 'lohia_monitor:shifts_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
                </a>
                <a href="{% url 'lohia_monitor:machine_stats' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/machine1/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–∑–æ–≤–æ–≤:', wsUrl);
    updateWebSocketStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–∑–æ–≤–æ–≤');
        updateWebSocketStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
        reconnectAttempts = 0;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–∑–æ–≤–æ–≤
        requestMaintenanceData();
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤—ã–∑–æ–≤–æ–≤:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–∑–æ–≤–æ–≤ –º–∞—Å—Ç–µ—Ä–∞
            if (data.type === 'maintenance_data' || data.type === 'maintenance_update') {
                updateMaintenanceTable(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        lohiaSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            // Fallback –Ω–∞ AJAX
            startAjaxFallback();
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function requestMaintenanceData() {
    if (lohiaSocket && lohiaSocket.readyState === WebSocket.OPEN) {
        lohiaSocket.send(JSON.stringify({type: 'get_maintenance_data'}));
    }
}

function updateMaintenanceTable(maintenanceData) {
    const tbody = document.getElementById('maintenance-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (maintenanceData && Array.isArray(maintenanceData)) {
        maintenanceData.forEach(call => {
            const row = document.createElement('tr');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å badge
            let statusBadge = '';
            if (call.status === 'pending' || call.status === '–û–∂–∏–¥–∞–µ—Ç') {
                statusBadge = '<span class="lohia-badge lohia-badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>';
            } else if (call.status === 'in_progress' || call.status === '–í —Ä–∞–±–æ—Ç–µ') {
                statusBadge = '<span class="lohia-badge lohia-badge-info">–í —Ä–∞–±–æ—Ç–µ</span>';
            } else {
                statusBadge = '<span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω</span>';
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
            const callTime = new Date(call.call_time);
            
            row.innerHTML = `
                <td>${callTime.toLocaleDateString('ru-RU')}</td>
                <td>${callTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</td>
                <td>${call.operator || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td>${call.master || '<span class="text-muted">‚Äî</span>'}</td>
                <td>${call.response_time || '<span class="text-muted">‚Äî</span>'}</td>
                <td>${call.repair_time || '<span class="text-muted">‚Äî</span>'}</td>
                <td>${statusBadge}</td>
                <td>${call.description || '<span class="text-muted">‚Äî</span>'}</td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—ã–∑–æ–≤–∞—Ö –º–∞—Å—Ç–µ—Ä–∞</td></tr>';
    }
}

// Fallback –Ω–∞ AJAX –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX fallback –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–∑–æ–≤–æ–≤');
    updateInterval = setInterval(updateMaintenanceHistory, 5000);
}

function updateMaintenanceHistory() {
    fetch('/lohia/api/maintenance-history/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMaintenanceTable(data.calls);
            }
        })
        .catch(error => {
            console.error('Error updating maintenance history:', error);
        });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–∑–æ–≤–æ–≤ —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>

{% endblock %}
