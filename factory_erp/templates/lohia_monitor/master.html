{% extends 'base.html' %}
{% load static %}

{% block title %}–ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞{% endblock %}

{% block content %}
<div class="lohia-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="lohia-card" style="margin-bottom: 15px;">
        <div class="lohia-card-header" style="font-size: 16px; padding: 10px 15px;">
            üîß –ü–∞–Ω–µ–ª—å –º–∞—Å—Ç–µ—Ä–∞
            <div id="ws-status" style="float: right; font-size: 11px; padding: 3px 8px; border-radius: 4px; background: #fff3cd; color: #856404;">
                üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
            </div>
        </div>
    </div>

    <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã -->
    <div class="lohia-card" style="margin-bottom: 15px;">
        <div class="lohia-card-header" style="font-size: 14px; padding: 10px 15px; background: #dc3545; color: white;">
            ‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—ã–∑–æ–≤—ã
        </div>
        <div class="lohia-card-body" style="padding: 15px;">
            <div id="active-calls-container">
                <p style="text-align: center; color: #999; font-size: 13px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–Ω–∫–æ–≤ -->
    <div class="lohia-card">
        <div class="lohia-card-header" style="font-size: 14px; padding: 10px 15px;">
            üìã –í—Å–µ —Å—Ç–∞–Ω–∫–∏
        </div>
        <div class="lohia-card-body" style="padding: 15px;">
            <div class="lohia-table-wrapper">
                <table class="lohia-table lohia-table-compact">
                    <thead>
                        <tr>
                            <th style="width: 40px;">‚Ññ</th>
                            <th style="width: 150px;">–ò–º—è —Å—Ç–∞–Ω–∫–∞</th>
                            <th style="width: 100px;">–°—Ç–∞—Ç—É—Å</th>
                            <th style="width: 180px;">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                            <th style="width: 120px;">–í—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞</th>
                            <th style="width: 150px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="machines-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999; padding: 30px; font-size: 13px;">
                                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ñ—É—Ä–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="lohia-card" style="margin-top: 15px;">
        <div class="lohia-card-header" style="font-size: 14px; padding: 10px 15px;">
            üìã –ñ—É—Ä–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        </div>
        <div class="lohia-card-body" style="padding: 15px;">
            <div id="log" style="height: 200px; overflow: auto; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: monospace; font-size: 11px;"></div>
        </div>
    </div>
</div>

<script>
let ws = null;
let reconnectAttempts = 0;
const maxReconnect = 5;
const reconnectDelay = 3000;
let machinesData = [];
let previousCallsCount = 0;
let alertAudio = null;

function setWsStatus(state) {
    const el = document.getElementById('ws-status');
    if (!el) return;
    if (state === 'connected') {
        el.style.background = '#d4edda';
        el.style.color = '#155724';
        el.textContent = 'üü¢ WS –ø–æ–¥–∫–ª—é—á–µ–Ω';
    } else if (state === 'connecting') {
        el.style.background = '#fff3cd';
        el.style.color = '#856404';
        el.textContent = 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
    } else {
        el.style.background = '#f8d7da';
        el.style.color = '#721c24';
        el.textContent = 'üî¥ WS –æ—Ç–∫–ª—é—á–µ–Ω';
    }
}

function logLine(text, color) {
    const log = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.style.color = color || '#000';
    div.textContent = `[${time}] ${text}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

function initAudio() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞
    alertAudio = new Audio('{% static "audio/alert.mp3" %}');
    alertAudio.preload = 'auto';
    
    // –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    alertAudio.addEventListener('canplaythrough', () => {
        logLine('–ó–≤—É–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤', 'green');
    });
    
    alertAudio.addEventListener('error', (e) => {
        logLine('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–≤—É–∫–∞: ' + e.message, 'red');
    });
}

async function requestPermissions() {
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('{% static "js/sw.js" %}');
            logLine('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'green');
            console.log('SW registered:', registration);
        } catch (error) {
            logLine('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker: ' + error, 'red');
        }
    }
    
    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ("Notification" in window) {
        if (Notification.permission === "default") {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                logLine('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–æ', 'green');
            } else {
                logLine('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ', 'orange');
            }
        } else if (Notification.permission === "granted") {
            logLine('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã', 'green');
        } else {
            logLine('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã', 'red');
        }
    }
    
    // –î–ª—è –∑–≤—É–∫–∞ –Ω—É–∂–Ω–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É
    const testButton = document.createElement('button');
    testButton.textContent = 'üîä –¢–µ—Å—Ç –∑–≤—É–∫–∞';
    testButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; z-index: 1000;';
    testButton.onclick = () => {
        playAlert();
        logLine('–¢–µ—Å—Ç –∑–≤—É–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'blue');
    };
    document.body.appendChild(testButton);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Ç–µ—Å—Ç–∞ —Ñ–æ–Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const backgroundTestButton = document.createElement('button');
    backgroundTestButton.textContent = 'üîî –¢–µ—Å—Ç —Ñ–æ–Ω–∞';
    backgroundTestButton.style.cssText = 'position: fixed; bottom: 20px; right: 140px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; z-index: 1000;';
    backgroundTestButton.onclick = () => {
        testBackgroundNotification();
    };
    document.body.appendChild(backgroundTestButton);
}

function connect() {
    const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${proto}//${window.location.host}/ws/lohia/dashboard/`;
    setWsStatus('connecting');
    logLine('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', '#666');
    
    ws = new WebSocket(url);
    
    ws.onopen = () => {
        setWsStatus('connected');
        reconnectAttempts = 0;
        logLine('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'green');
    };
    
    ws.onmessage = (ev) => {
        try {
            const msg = JSON.parse(ev.data);
            handleMessage(msg);
        } catch (e) {
            logLine('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e, 'red');
        }
    };
    
    ws.onclose = () => {
        setWsStatus('disconnected');
        logLine('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'red');
        if (reconnectAttempts < maxReconnect) {
            reconnectAttempts++;
            logLine(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ${reconnectAttempts}/${maxReconnect}...`, 'orange');
            setTimeout(connect, reconnectDelay);
        }
    };
    
    ws.onerror = (e) => {
        logLine('–û—à–∏–±–∫–∞ WebSocket', 'red');
    };
}

function handleMessage(msg) {
    logLine(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${msg.type}`, '#666');
    
    if (msg.type === 'machine_status' && Array.isArray(msg.data)) {
        updateMachinesData(msg.data);
    }
}

function updateMachinesData(data) {
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–∑–æ–≤—ã PENDING
    const currentCalls = data.filter(m => m.call_status === 'pending');
    const currentCallsCount = currentCalls.length;
    
    logLine(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${currentCallsCount} –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤`, '#666');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –ù–û–í–´–ï –≤—ã–∑–æ–≤—ã
    if (currentCallsCount > previousCallsCount) {
        const newCallsCount = currentCallsCount - previousCallsCount;
        logLine(`üîî –ù–û–í–´–ô –í–´–ó–û–í! –í—Å–µ–≥–æ: ${currentCallsCount}`, 'red');
        notifyMaster(currentCalls);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    previousCallsCount = currentCallsCount;
    machinesData = data;
    
    updateUI();
}

function updateUI() {
    updateMachinesTable();
    updateActiveCalls();
}

function updateMachinesTable() {
    const tbody = document.getElementById('machines-tbody');
    if (!tbody) return;
    
    if (machinesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω–∫–∞—Ö</td></tr>';
        return;
    }
    
    tbody.innerHTML = machinesData.map((machine, index) => {
        const statusHtml = getStatusHtml(machine.status);
        const callHtml = getCallHtml(machine.call_status);
        const actionHtml = getActionHtml(machine);
        
        return `
            <tr class="machine-row" data-machine-id="${machine.machine_id}">
                <td style="text-align: center; font-size: 12px;">${index + 1}</td>
                <td style="font-size: 12px; font-weight: 500;">${machine.name}</td>
                <td style="font-size: 12px;">${statusHtml}</td>
                <td style="font-size: 12px;">${machine.current_operator || '<span style="color: #999;">‚Äî</span>'}</td>
                <td style="font-size: 12px; text-align: center;">${callHtml}</td>
                <td style="font-size: 12px;">${actionHtml}</td>
            </tr>
        `;
    }).join('');
}

function updateActiveCalls() {
    const container = document.getElementById('active-calls-container');
    if (!container) return;
    
    const activeCalls = machinesData.filter(m => m.call_status === 'pending' || m.call_status === 'in_progress');
    
    if (activeCalls.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; font-size: 13px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤</p>';
        return;
    }
    
    container.innerHTML = activeCalls.map(machine => `
        <div style="background: ${machine.call_status === 'pending' ? '#fff3cd' : '#d1ecf1'}; border-left: 4px solid ${machine.call_status === 'pending' ? '#ffc107' : '#17a2b8'}; padding: 12px; margin-bottom: 10px; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 5px 0; font-size: 14px;">${machine.call_status === 'pending' ? '‚ö†Ô∏è' : 'üîß'} ${machine.name}</h4>
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        –û–ø–µ—Ä–∞—Ç–æ—Ä: ${machine.current_operator || '‚Äî'}
                    </p>
                    <p style="margin: 0; font-size: 12px; color: #666;">
                        –°—Ç–∞—Ç—É—Å: ${machine.call_status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –º–∞—Å—Ç–µ—Ä–∞' : '–ú–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + (machine.master || '‚Äî')}
                    </p>
                </div>
                <div>
                    ${getActionHtml(machine)}
                </div>
            </div>
        </div>
    `).join('');
}

function getStatusHtml(status) {
    const statuses = {
        'working': '<span style="color: #28a745;">üü¢ –†–∞–±–æ—Ç–∞–µ—Ç</span>',
        'maintenance': '<span style="color: #ffc107;">üü° –†–µ–º–æ–Ω—Ç</span>',
        'stopped': '<span style="color: #dc3545;">üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>',
        'idle': '<span style="color: #6c757d;">‚ö™ –ü—Ä–æ—Å—Ç–æ–π</span>'
    };
    return statuses[status] || statuses['idle'];
}

function getCallHtml(callStatus) {
    if (callStatus === 'pending') {
        return '<span style="color: #dc3545; font-weight: 600;">‚ö†Ô∏è –î–∞</span>';
    } else if (callStatus === 'in_progress') {
        return '<span style="color: #ffc107; font-weight: 600;">üîß –í —Ä–∞–±–æ—Ç–µ</span>';
    }
    return '<span style="color: #28a745;">‚úì –ù–µ—Ç</span>';
}

function getActionHtml(machine) {
    if (machine.call_status === 'pending') {
        return `<button onclick="acceptCall(${machine.machine_id}, '${machine.name}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úì –ü—Ä–∏–Ω—è—Ç—å</button>`;
    } else if (machine.call_status === 'in_progress') {
        return `<button onclick="completeRepair(${machine.machine_id}, '${machine.name}')" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>`;
    }
    return '<span style="color: #999;">‚Äî</span>';
}

function acceptCall(machineId, machineName) {
    logLine(`–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç—å –≤—ã–∑–æ–≤ –æ—Ç ${machineName}`, '#007bff');
    alert('–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –≤—ã–∑–æ–≤–∞ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ RFID –∫–∞—Ä—Ç—É –∫ —Å—Ç–∞–Ω–∫—É');
}

function completeRepair(machineId, machineName) {
    logLine(`–†–µ–º–æ–Ω—Ç —Å—Ç–∞–Ω–∫–∞ ${machineName} –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è...`, '#28a745');
    alert('–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ RFID –∫–∞—Ä—Ç—É –∫ —Å—Ç–∞–Ω–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ');
}

function playAlert() {
    if (!alertAudio) {
        logLine('–ó–≤—É–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'red');
        return;
    }
    
    alertAudio.currentTime = 0;
    alertAudio.play()
        .then(() => {
            logLine('–ó–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω', 'green');
        })
        .catch((e) => {
            logLine('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ' + e.message, 'red');
        });
}

function notifyMaster(calls) {
    const callsText = calls.map(m => m.name).join(', ');
    
    // 1. –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if (navigator.vibrate) {
        // –°–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: –≤–∏–±—Ä–æ-–ø–∞—É–∑–∞-–≤–∏–±—Ä–æ-–ø–∞—É–∑–∞-–≤–∏–±—Ä–æ
        navigator.vibrate([400, 150, 400, 150, 400]);
        logLine('–í–∏–±—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞', 'blue');
    } else {
        logLine('–í–∏–±—Ä–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'orange');
    }
    
    // 2. –ó–≤—É–∫ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
    playAlert();
    
    // 3. –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
    if ("Notification" in window && Notification.permission === "granted") {
        const notification = new Notification("üîß –í—ã–∑–æ–≤ –º–∞—Å—Ç–µ—Ä–∞!", {
            body: `–°—Ç–∞–Ω–∫–∏: ${callsText}`,
            icon: "{% static 'favicon.ico' %}",
            badge: "{% static 'favicon.ico' %}",
            requireInteraction: true,
            vibrate: [400, 150, 400, 150, 400],
            tag: 'maintenance-call', // –ß—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
        });
        
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
        
        logLine('Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'green');
    } else {
        logLine('Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', 'orange');
    }
    
    // 4. –§–æ–Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Service Worker
    sendBackgroundNotification(callsText);
    
    // 5. –í–∏–∑—É–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    showVisualAlert(callsText);
}

function sendBackgroundNotification(callsText) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Service Worker –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
            type: 'MAINTENANCE_CALL',
            machines: callsText
        });
        logLine('–§–æ–Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'green');
    } else {
        logLine('Service Worker –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'orange');
    }
}

function testBackgroundNotification() {
    logLine('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...', 'blue');
    sendBackgroundNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–∞–Ω–æ–∫');
}

function showVisualAlert(text) {
    // –°–æ–∑–¥–∞–µ–º –±–æ–ª—å—à–æ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #dc3545;
        color: white;
        padding: 30px 40px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 9999;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
        animation: pulse 1s infinite;
    `;
    alert.innerHTML = `
        <div style="font-size: 40px; margin-bottom: 10px;">üîß</div>
        <div>–í–´–ó–û–í –ú–ê–°–¢–ï–†–ê!</div>
        <div style="font-size: 16px; margin-top: 10px; font-weight: normal;">${text}</div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é
    if (!document.getElementById('pulse-animation')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation';
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: translate(-50%, -50%) scale(1); }
                50% { transform: translate(-50%, -50%) scale(1.05); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(alert);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ –º–∞—Å—Ç–µ—Ä–∞');
    logLine('–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞', 'green');
    
    initAudio();
    requestPermissions();
    connect();
});

window.addEventListener('beforeunload', () => {
    if (ws) {
        ws.close();
    }
});
</script>
{% endblock %}