{% extends 'base.html' %}
{% load tz %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω - –°—Ç–∞–Ω–æ–∫ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <div class="lohia-card">
        <div class="lohia-card-header">
            üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
            <div id="websocket-status" style="display: none; float: right; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
            </div>
        </div>
    </div>

    <div class="lohia-card">
        <div class="lohia-card-header">
            –í—Å–µ —Å–º–µ–Ω—ã
        </div>
        <div class="lohia-card-body">
            {% if shifts %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                        <th>–°—Ç–∞–Ω–æ–∫</th>
                                        <th>–ù–∞—á–∞–ª–æ</th>
                                        <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                        <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                        <th>–ò–º–ø—É–ª—å—Å—ã</th>
                                        <th>–ú–µ—Ç—Ä–∞–∂</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="shifts-table-body">
                                    {% for shift in shifts %}
                                    <tr>
                                        <td>{{ shift.start_time|localtime|date:"d.m.Y" }}</td>
                                        <td>{{ shift.operator.get_full_name }}</td>
                                        <td>{{ shift.machine.name }}</td>
                                        <td>{{ shift.start_time|localtime|date:"H:i" }}</td>
                                        <td>
                                            {% if shift.end_time %}
                                                {{ shift.end_time|localtime|date:"H:i" }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if shift.end_time %}
                                                {{ shift.duration_hours|floatformat:1 }} —á
                                            {% else %}
                                                <span class="text-primary">{{ shift.duration_hours|floatformat:1 }} —á</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ shift.total_pulses }}</td>
                                        <td>{{ shift.total_meters|floatformat:6 }} –º</td>
                                        <td>
                                            {% if shift.status == 'active' %}
                                                <span class="lohia-badge lohia-badge-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                            {% else %}
                                                <span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
            {% else %}
                <p style="text-align: center; color: #666; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö</p>
            {% endif %}
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card">
        <div class="lohia-card-body">
            <h5 style="margin-bottom: 15px; text-align: center;">üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:dashboard' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üè† –î–∞—à–±–æ—Ä–¥
                </a>
                <a href="{% url 'lohia_monitor:maintenance_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
                </a>
                <a href="{% url 'lohia_monitor:machine_stats' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// ========== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –í–†–ï–ú–ï–ù–ò ==========
function formatDuration(hours) {
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —á–∞—Å–æ–≤ –≤ "X —á Y –º–∏–Ω"
     * @param {number} hours - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∞—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä 8.5)
     * @returns {string} - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "8 —á 30 –º–∏–Ω")
     */
    if (!hours || hours === 0) return '‚Äî';
    
    const totalMinutes = Math.round(hours * 60);
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    
    if (h > 0 && m > 0) {
        return `${h} —á ${m} –º–∏–Ω`;
    } else if (h > 0) {
        return `${h} —á`;
    } else {
        return `${m} –º–∏–Ω`;
    }
}

// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;
let updateInterval = null;

function updateWebSocketStatus(status) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω —á–µ—Ä–µ–∑ API (–æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
function loadShiftsHistory() {
    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω —á–µ—Ä–µ–∑ API');
    
    fetch('/lohia/api/shifts-history/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.shifts.length} —Å–º–µ–Ω`);
                updateShiftsTable(data.shifts);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω:', data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω:', error);
        });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö API
function updateShiftsTable(shifts) {
    const tbody = document.getElementById('shifts-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (shifts && Array.isArray(shifts) && shifts.length > 0) {
        shifts.forEach(shift => {
            const row = document.createElement('tr');
            
            // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É/–≤—Ä–µ–º—è
            const startTime = new Date(shift.start_time);
            const endTime = shift.end_time ? new Date(shift.end_time) : null;
            
            // –°—Ç–∞—Ç—É—Å badge
            let statusBadge = '';
            if (shift.status === '–ê–∫—Ç–∏–≤–Ω–∞' || shift.status === 'active') {
                statusBadge = '<span class="lohia-badge lohia-badge-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>';
            } else {
                statusBadge = '<span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>';
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            let durationDisplay = '‚Äî';
            if (shift.duration && shift.duration !== '–ê–∫—Ç–∏–≤–Ω–∞') {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∞ —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "8.5 —á" - –ø–∞—Ä—Å–∏–º —á–∞—Å—ã
                const hoursMatch = shift.duration.match(/(\d+\.?\d*)\s*—á/);
                if (hoursMatch) {
                    const hours = parseFloat(hoursMatch[1]);
                    durationDisplay = formatDuration(hours);
                    // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω - —Å–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º
                    if (shift.status === '–ê–∫—Ç–∏–≤–Ω–∞' || shift.status === 'active') {
                        durationDisplay = `<span style="color: #007bff; font-weight: 500;">${durationDisplay}</span>`;
                    }
                } else {
                    durationDisplay = shift.duration;
                }
            }
            
            row.innerHTML = `
                <td>${startTime.toLocaleDateString('ru-RU')}</td>
                <td>${shift.operator || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td>${shift.machine || 'Lohia'}</td>
                <td>${startTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</td>
                <td>${endTime ? endTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}) : '<span class="text-muted">‚Äî</span>'}</td>
                <td>${durationDisplay}</td>
                <td>${shift.total_pulses || 0}</td>
                <td>${(shift.total_meters || 0).toFixed(6)} –º</td>
                <td>${statusBadge}</td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö</td></tr>';
    }
}

// WebSocket - —Ç–æ–ª—å–∫–æ –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/dashboard/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket:', wsUrl);
    updateWebSocketStatus('connecting');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        updateWebSocketStatus('connected');
        reconnectAttempts = 0;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AJAX polling –µ—Å–ª–∏ –±—ã–ª –∑–∞–ø—É—â–µ–Ω
        if (updateInterval) {
            clearInterval(updateInterval);
            updateInterval = null;
        }
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® WebSocket —Ç—Ä–∏–≥–≥–µ—Ä - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω');
            
            // –ü—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç WebSocket - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ API
            loadShiftsHistory();
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected');
        lohiaSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected');
            // Fallback –Ω–∞ AJAX polling
            startAjaxFallback();
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

// Fallback –Ω–∞ AJAX polling –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX polling (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)');
    updateInterval = setInterval(loadShiftsHistory, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω');
    
    // 1. –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–µ—Ä–µ–∑ API
    loadShiftsHistory();
    
    // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    connectWebSocket();
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>

{% endblock %}
