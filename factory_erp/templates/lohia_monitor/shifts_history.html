{% extends 'base.html' %}
{% load tz %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω - –°—Ç–∞–Ω–æ–∫ Lohia{% endblock %}

{% block content %}
<div class="lohia-container">
    <div class="lohia-card">
        <div class="lohia-card-header">
            üìä –ò—Å—Ç–æ—Ä–∏—è —Å–º–µ–Ω
            <div id="websocket-status" style="float: right; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
            </div>
        </div>
    </div>

    <div class="lohia-card">
        <div class="lohia-card-header">
            –í—Å–µ —Å–º–µ–Ω—ã
        </div>
        <div class="lohia-card-body">
            {% if shifts %}
                <div class="lohia-table-wrapper">
                    <table class="lohia-table">
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
                                        <th>–°—Ç–∞–Ω–æ–∫</th>
                                        <th>–ù–∞—á–∞–ª–æ</th>
                                        <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                                        <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                                        <th>–ò–º–ø—É–ª—å—Å—ã</th>
                                        <th>–ú–µ—Ç—Ä–∞–∂</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="shifts-table-body">
                                    {% for shift in shifts %}
                                    <tr>
                                        <td>{{ shift.start_time|localtime|date:"d.m.Y" }}</td>
                                        <td>{{ shift.operator.get_full_name }}</td>
                                        <td>{{ shift.machine.name }}</td>
                                        <td>{{ shift.start_time|localtime|date:"H:i" }}</td>
                                        <td>
                                            {% if shift.end_time %}
                                                {{ shift.end_time|localtime|date:"H:i" }}
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if shift.end_time %}
                                                {{ shift.duration_hours|floatformat:1 }} —á
                                            {% else %}
                                                <span class="text-primary">{{ shift.duration_hours|floatformat:1 }} —á</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ shift.total_pulses }}</td>
                                        <td>{{ shift.total_meters|floatformat:6 }} –º</td>
                                        <td>
                                            {% if shift.status == 'active' %}
                                                <span class="lohia-badge lohia-badge-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>
                                            {% else %}
                                                <span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
            {% else %}
                <p style="text-align: center; color: #666; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö</p>
            {% endif %}
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="lohia-card">
        <div class="lohia-card-body">
            <h5 style="margin-bottom: 15px; text-align: center;">üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <div class="lohia-nav-buttons">
                <a href="{% url 'lohia_monitor:dashboard' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üè† –î–∞—à–±–æ—Ä–¥
                </a>
                <a href="{% url 'lohia_monitor:maintenance_history' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üîß –ò—Å—Ç–æ—Ä–∏—è –≤—ã–∑–æ–≤–æ–≤
                </a>
                <a href="{% url 'lohia_monitor:machine_stats' %}" class="lohia-nav-btn lohia-nav-btn-outline">
                    üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let lohiaSocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/lohia/machine1/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω:', wsUrl);
    updateWebSocketStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    
    lohiaSocket = new WebSocket(wsUrl);
    
    lohiaSocket.onopen = function(event) {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω');
        updateWebSocketStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
        reconnectAttempts = 0;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–º–µ–Ω
        requestShiftsData();
    };
    
    lohiaSocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å–º–µ–Ω:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–º–µ–Ω
            if (data.type === 'shift_data' || data.type === 'shift_update') {
                updateShiftsTable(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    lohiaSocket.onclose = function(event) {
        console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        lohiaSocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            // Fallback –Ω–∞ AJAX
            startAjaxFallback();
        }
    };
    
    lohiaSocket.onerror = function(error) {
        console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function requestShiftsData() {
    if (lohiaSocket && lohiaSocket.readyState === WebSocket.OPEN) {
        lohiaSocket.send(JSON.stringify({type: 'get_shift_data'}));
    }
}

function updateShiftsTable(shiftsData) {
    const tbody = document.getElementById('shifts-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (shiftsData && Array.isArray(shiftsData)) {
        shiftsData.forEach(shift => {
            const row = document.createElement('tr');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å badge
            let statusBadge = '';
            if (shift.status === 'active' || shift.status === '–ê–∫—Ç–∏–≤–Ω–∞') {
                statusBadge = '<span class="lohia-badge lohia-badge-primary">–ê–∫—Ç–∏–≤–Ω–∞</span>';
            } else {
                statusBadge = '<span class="lohia-badge lohia-badge-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>';
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å —Ü–≤–µ—Ç–æ–º
            let durationDisplay = '';
            if (shift.end_time === null || shift.end_time === '–ê–∫—Ç–∏–≤–Ω–∞') {
                durationDisplay = `<span class="text-primary">${shift.duration || '–ê–∫—Ç–∏–≤–Ω–∞'}</span>`;
            } else {
                durationDisplay = shift.duration || '‚Äî';
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
            const startTime = new Date(shift.start_time);
            const endTime = shift.end_time ? new Date(shift.end_time) : null;
            
            row.innerHTML = `
                <td>${startTime.toLocaleDateString('ru-RU')}</td>
                <td>${shift.operator || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                <td>${shift.machine || '–°—Ç–∞–Ω–æ–∫ Lohia #1'}</td>
                <td>${startTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</td>
                <td>${endTime ? endTime.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}) : '<span class="text-muted">‚Äî</span>'}</td>
                <td>${durationDisplay}</td>
                <td>${shift.current_pulses || shift.total_pulses || 0}</td>
                <td>${(shift.total_meters || 0).toFixed(6)} –º</td>
                <td>${statusBadge}</td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–º–µ–Ω–∞—Ö</td></tr>';
    }
}

// Fallback –Ω–∞ AJAX –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX fallback –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω');
    updateInterval = setInterval(updateShiftsHistory, 5000);
}

function updateShiftsHistory() {
    fetch('/lohia/api/shifts-history/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateShiftsTable(data.shifts);
            }
        })
        .catch(error => {
            console.error('Error updating shifts history:', error);
        });
}

// –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–º–µ–Ω —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (lohiaSocket) {
        lohiaSocket.close();
    }
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>

{% endblock %}
