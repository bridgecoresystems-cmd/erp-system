{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block content %}
<div class="security-body">
    <div class="security-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã -->
        <div class="security-header">
            <h1>
                üõ°Ô∏è –ü–∞–Ω–µ–ª—å –æ—Ö—Ä–∞–Ω—ã
                <div id="websocket-status" style="display: none; margin-left: 10px; font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #f8d7da; color: #721c24;">
                    üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω
                </div>
            </h1>
            <div class="shift-controls">
                {% if active_shift %}
                    <span class="shift-status shift-active">
                        ‚úÖ –°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å {{ active_shift.start_time|localtime|date:"d.m.Y H:i" }}
                    </span>
                    <a href="{% url 'security:end_shift' %}" class="btn btn-danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</a>
                {% else %}
                    <span class="shift-status shift-inactive">
                        ‚ùå –°–º–µ–Ω–∞ –Ω–µ –Ω–∞—á–∞—Ç–∞
                    </span>
                    <a href="{% url 'security:start_shift' %}" class="btn btn-success">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</a>
                {% endif %}
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç -->
            <div class="security-card">
                <h3>üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç</h3>
                <div class="scan-area" id="scanArea">
                    <div class="waiting-scan" id="waitingScan">
                        <div class="scan-icon">üè∑Ô∏è</div>
                        <div class="scan-text">–û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã...</div>
                        <div class="scan-subtext">–ü—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç—É –∫ —Å—á–∏—Ç—ã–≤–∞—Ç–µ–ª—é</div>
                    </div>
                    
                    <div class="employee-scan-info" id="employeeScanInfo" style="display: none;">
                        <div class="scan-photo-large">
                            <img src="" alt="–§–æ—Ç–æ" id="scanEmployeePhoto">
                        </div>
                        <div class="scan-details-extended">
                            <div class="scan-name" id="scanEmployeeName"></div>
                            <div class="scan-info-grid">
                                <div class="info-item">
                                    <span class="info-label">–û—Ç–¥–µ–ª:</span>
                                    <span class="info-value" id="scanEmployeeDepartment"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
                                    <span class="info-value" id="scanEmployeePosition"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">–¢–∞–±–µ–ª—å–Ω—ã–π ‚Ññ:</span>
                                    <span class="info-value" id="scanEmployeeId"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">–ö–∞—Ä—Ç–∞:</span>
                                    <span class="info-value" id="scanEmployeeCard"></span>
                                </div>
                            </div>
                            <div class="scan-action" id="scanAction"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –°—Ç–∞—Ç—É—Å –∏ –ª–æ–≥–∏ -->
            <div>
                <!-- –°—Ç–∞—Ç—É—Å –æ—Ñ–∏—Å–∞ -->
                <div class="security-card office-status">
                    <div class="office-counter">
                        <h4>{{ employees_in_office|length }}</h4>
                        <div>—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ñ–∏—Å–µ</div>
                    </div>
                    {% if employees_in_office %}
                    <div>
                        <strong>–°–µ–π—á–∞—Å –≤ –æ—Ñ–∏—Å–µ:</strong>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            {% for employee in employees_in_office %}
                            <li>{{ employee.get_full_name }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ -->
                <div class="security-card">
                    <h3>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                    <div class="recent-logs">
                        {% for log in recent_logs %}
                        <div class="log-entry log-{{ log.action }}">
                            <div class="log-time">{{ log.timestamp|localtime|date:"d.m.Y H:i" }}</div>
                            <div class="log-action">
                                {{ log.employee.get_full_name }} - {{ log.get_action_display }}
                            </div>
                            <div style="font-size: 12px; color: #7f8c8d;">
                                –û—Ö—Ä–∞–Ω–Ω–∏–∫: {{ log.security_guard.username|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}
                            </div>
                        </div>
                        {% empty %}
                        <div style="text-align: center; color: #7f8c8d;">
                            –ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —ç–∫—Å–ø–æ—Ä—Ç -->
        <div class="controls-section">
            <h3>üìä –û—Ç—á–µ—Ç—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç</h3>
            <div class="export-controls">
                <a href="{% url 'security:logs_report' %}" class="btn">
                    üìà –û—Ç—á–µ—Ç –ø–æ –ª–æ–≥–∞–º
                </a>
                <a href="{% url 'security:export_excel' %}" class="btn btn-success">
                    üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (–Ω–µ–¥–µ–ª—è)
                </a>
                <a href="{% url 'security:export_excel' %}?date_from={{ today|date:'Y-m-d' }}" class="btn btn-warning">
                    üìÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è
                </a>
            </div>
        </div>
    </div>
</div>

{% if messages %}
<div id="messages" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
<script>
    setTimeout(function() {
        document.getElementById('messages').style.display = 'none';
    }, 3000);
</script>
{% endif %}

<style>
/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ */
.scan-photo-large img {
    width: 160px;  /* –í –¥–≤–∞ —Ä–∞–∑–∞ –∫—Ä—É–ø–Ω–µ–µ */
    height: 160px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #e9ecef;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.scan-details-extended {
    flex: 1;
    padding-left: 25px;
}

.scan-name {
    font-size: 1.6em;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 15px;
}

.scan-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.info-label {
    font-size: 12px;
    font-weight: 600;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 14px;
    font-weight: 500;
    color: #2c3e50;
    background: #f8f9fa;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.scan-action {
    font-size: 1.2em;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 8px;
    text-align: center;
    margin-top: 15px;
}
</style>

<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
let securitySocket = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const reconnectDelay = 3000;
let lastAccessId = null;
let isPageReloading = false;

function updateWebSocketStatus(status, message) {
    const statusEl = document.getElementById('websocket-status');
    if (statusEl) {
        if (status === 'connected') {
            statusEl.style.background = '#d4edda';
            statusEl.style.color = '#155724';
            statusEl.innerHTML = 'üü¢ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω';
        } else if (status === 'connecting') {
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.innerHTML = 'üü° WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...';
        } else {
            statusEl.style.background = '#f8d7da';
            statusEl.style.color = '#721c24';
            statusEl.innerHTML = 'üî¥ WebSocket –æ—Ç–∫–ª—é—á–µ–Ω';
        }
    }
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/security/`;
    
    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Security WebSocket:', wsUrl);
    updateWebSocketStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    
    securitySocket = new WebSocket(wsUrl);
    
    securitySocket.onopen = function(event) {
        console.log('‚úÖ Security WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        updateWebSocketStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω');
        reconnectAttempts = 0;
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        requestSecurityData();
    };
    
    securitySocket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:', data);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–æ—Å—Ç—É–ø–∞
            if (data.type === 'access_event' || data.type === 'security_update') {
                handleAccessEvent(data.data);
            } else if (data.type === 'security_data') {
                updateSecurityData(data.data);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    };
    
    securitySocket.onclose = function(event) {
        console.log('‚ùå Security WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', event.code, event.reason);
        updateWebSocketStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω');
        securitySocket = null;
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${reconnectDelay/1000} —Å–µ–∫`);
            setTimeout(connectWebSocket, reconnectDelay);
        } else {
            console.error('üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            updateWebSocketStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            // Fallback –Ω–∞ AJAX
            startAjaxFallback();
        }
    };
    
    securitySocket.onerror = function(error) {
        console.error('‚ùå Security WebSocket –æ—à–∏–±–∫–∞:', error);
    };
}

function requestSecurityData() {
    if (securitySocket && securitySocket.readyState === WebSocket.OPEN) {
        securitySocket.send(JSON.stringify({type: 'get_security_data'}));
    }
}

function handleAccessEvent(accessData) {
    if (!accessData) return;
    
    console.log('üîî –°–æ–±—ã—Ç–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—É—á–µ–Ω–æ:', accessData);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
    showScannedEmployee(accessData.employee, accessData.action);
}

function updateSecurityData(securityData) {
    if (!securityData) return;
    
    console.log('üìä –î–∞–Ω–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', securityData);
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ñ–∏—Å–µ, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ —Ç.–¥.
}

// –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
function showScannedEmployee(employeeData, action) {
    const waitingScan = document.getElementById('waitingScan');
    const employeeScanInfo = document.getElementById('employeeScanInfo');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    document.getElementById('scanEmployeePhoto').src = employeeData.photo_url || '/static/images/no-photo.png';
    document.getElementById('scanEmployeeName').textContent = employeeData.full_name;
    document.getElementById('scanEmployeeDepartment').textContent = employeeData.department || '‚Äî';
    document.getElementById('scanEmployeePosition').textContent = employeeData.position || '‚Äî';
    document.getElementById('scanEmployeeId').textContent = employeeData.employee_id || '‚Äî';
    document.getElementById('scanEmployeeCard').textContent = employeeData.rfid_uid || '‚Äî';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ —Å —Ü–≤–µ—Ç–æ–º
    const scanAction = document.getElementById('scanAction');
    if (action === 'in') {
        scanAction.textContent = '‚úÖ –í–•–û–î –†–ê–ó–†–ï–®–ï–ù';
        scanAction.style.color = '#27ae60';
        scanAction.style.backgroundColor = 'rgba(39, 174, 96, 0.1)';
        scanAction.style.border = '2px solid #27ae60';
    } else {
        scanAction.textContent = '‚ùå –í–´–•–û–î –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù';
        scanAction.style.color = '#e74c3c';
        scanAction.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
        scanAction.style.border = '2px solid #e74c3c';
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ
    waitingScan.style.display = 'none';
    employeeScanInfo.style.display = 'flex';
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ–∂–∏–¥–∞–Ω–∏—é –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    setTimeout(() => {
        if (!isPageReloading) {
            isPageReloading = true;
            location.reload();
        }
    }, 5000);
}

// Fallback –Ω–∞ AJAX –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
function startAjaxFallback() {
    console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ AJAX fallback –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏');
    checkInterval = setInterval(checkForNewAccess, 3000);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∫–∞—Å–∞–Ω–∏–π (AJAX fallback)
async function checkForNewAccess() {
    if (isPageReloading) {
        return;
    }
    
    try {
        const response = await fetch('/security/api/latest-access/');
        const data = await response.json();
        
        if (data.success && data.has_new_access) {
            const currentAccessId = data.access_id;
            
            if (lastAccessId !== currentAccessId) {
                lastAccessId = currentAccessId;
                showScannedEmployee(data.employee, data.action);
            }
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∫–∞—Å–∞–Ω–∏–π:', error);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Security dashboard —Å WebSocket');
    connectWebSocket();
});

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º WebSocket –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    isPageReloading = true;
    if (securitySocket) {
        securitySocket.close();
    }
    if (checkInterval) {
        clearInterval(checkInterval);
    }
});
</script>
{% endblock %}