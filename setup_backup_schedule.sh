#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
# ERP —Å–∏—Å—Ç–µ–º–∞ - Factory ERP

BACKUP_SCRIPT="/home/batyr/projects/erp-system/backup_db.sh"
CRON_JOB_FILE="/tmp/erp_backup_cron"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –±—ç–∫–∞–ø–∞
if [ ! -f "$BACKUP_SCRIPT" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_SCRIPT"
    exit 1
fi

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É
echo "üìÖ –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è..."

# –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo ""
echo "1. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
echo "2. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00"
echo "3. –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
echo "4. –ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤"
echo "5. –¢–æ–ª—å–∫–æ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –≤ 02:00"
echo "6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç"
echo "7. –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo ""

read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-7): " choice

case $choice in
    1)
        CRON_SCHEDULE="0 2 * * *"
        DESCRIPTION="–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00"
        ;;
    2)
        CRON_SCHEDULE="0 3 * * *"
        DESCRIPTION="–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00"
        ;;
    3)
        CRON_SCHEDULE="0 */6 * * *"
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
        ;;
    4)
        CRON_SCHEDULE="0 */12 * * *"
        DESCRIPTION="–∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤"
        ;;
    5)
        CRON_SCHEDULE="0 2 * * 0"
        DESCRIPTION="–∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 02:00"
        ;;
    6)
        echo ""
        echo "–§–æ—Ä–º–∞—Ç cron: –º–∏–Ω—É—Ç–∞ —á–∞—Å –¥–µ–Ω—å –º–µ—Å—è—Ü –¥–µ–Ω—å_–Ω–µ–¥–µ–ª–∏"
        echo "–ü—Ä–∏–º–µ—Ä—ã:"
        echo "  0 2 * * *     - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00"
        echo "  0 */6 * * *   - –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"
        echo "  30 1 * * 1    - –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 01:30"
        echo ""
        read -p "–í–≤–µ–¥–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ cron: " CRON_SCHEDULE
        DESCRIPTION="–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $CRON_SCHEDULE"
        ;;
    7)
        echo "üóëÔ∏è –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        
        # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ cron –∑–∞–¥–∞—á–∏
        (crontab -l 2>/dev/null | grep -v "$BACKUP_SCRIPT") | crontab -
        
        echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ"
        echo ""
        echo "üí° –î–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
        echo "   $BACKUP_SCRIPT"
        exit 0
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É
echo "üìù –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º cron –∑–∞–¥–∞—á—É: $DESCRIPTION"

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏ (–∏—Å–∫–ª—é—á–∞—è –Ω–∞—à —Å–∫—Ä–∏–ø—Ç)
(crontab -l 2>/dev/null | grep -v "$BACKUP_SCRIPT"; echo "$CRON_SCHEDULE $BACKUP_SCRIPT >> /home/batyr/projects/erp-system/backups/cron.log 2>&1") | crontab -

if [ $? -eq 0 ]; then
    echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ!"
    echo ""
    echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏:"
    echo "   –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $DESCRIPTION"
    echo "   –°–∫—Ä–∏–ø—Ç: $BACKUP_SCRIPT"
    echo "   –õ–æ–≥: /home/batyr/projects/erp-system/backups/cron.log"
    echo ""
    echo "üìÖ –¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏:"
    crontab -l | grep -E "(backup|erp)" || echo "   (–∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã)"
    echo ""
    echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "   crontab -l                    - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ cron –∑–∞–¥–∞—á–∏"
    echo "   crontab -e                    - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å cron –∑–∞–¥–∞—á–∏"
    echo "   tail -f /home/batyr/projects/erp-system/backups/cron.log - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
    echo "   $BACKUP_SCRIPT               - —Ä—É—á–Ω–æ–π –±—ç–∫–∞–ø"
    echo ""
    echo "üîç –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã:"
    echo "   sudo systemctl status cron    - —Å—Ç–∞—Ç—É—Å cron —Å–µ—Ä–≤–∏—Å–∞"
    echo "   sudo systemctl start cron     - –∑–∞–ø—É—Å—Ç–∏—Ç—å cron —Å–µ—Ä–≤–∏—Å"
    echo "   sudo systemctl enable cron    - –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ cron"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ cron –∑–∞–¥–∞—á–∏"
    exit 1
fi
